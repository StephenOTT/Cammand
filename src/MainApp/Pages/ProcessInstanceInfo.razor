@using MainApp.Components.VariableInstance
@using MainApp.Components.Incident
@using MainApp.Components.UserTask
@using MainApp.Components.ProcessInstance
@using MainApp.Components.Job
@using MainApp.Components.ExternalTask
@using BpmnJs.Components
@using Camunda.Http.Api
@using Camunda.Http.Api.Model

@inject AppData AppData

@page "/process-instances/{instanceId}"

<Container Fluid="true">
<Row>
    <Column>
        <Heading Size="HeadingSize.Is1">Process Instance <code>@InstanceId</code> Details</Heading>
    </Column>
</Row>
@if (_instance != null)
{
    <Row Margin="Margin.Is1.OnY">
        <Column ColumnSize="ColumnSize.Is4.OnDesktop">
            <Card Style="height:100%">
                <CardHeader>
                    <CardTitle>Process Instance Attributes</CardTitle>
                </CardHeader>
                <CardBody>
                    <Paragraph>Process Instance ID: <code>@_instance.Id</code></Paragraph>
                    <Paragraph>State: <code>@_instance.State</code></Paragraph>
                    <Paragraph>Process Definition ID: <code>@_instance.ProcessDefinitionId</code></Paragraph>
                    <Paragraph>Process Definition Key: <code>@_instance.ProcessDefinitionKey</code></Paragraph>
                    <Paragraph>Process Definition Name: <code>@_instance.ProcessDefinitionName</code></Paragraph>
                    <Paragraph>Super Process Instance Id: <code>@_instance.SuperProcessInstanceId</code></Paragraph>
                    <Paragraph>Tenant ID: <code>@_instance.TenantId</code></Paragraph>
                    <Paragraph>Business Key: <code>@_instance.BusinessKey</code></Paragraph>
                    <Paragraph>Started At: <code>@_instance.StartTime</code></Paragraph>
                    <Paragraph>Ended At: <code>@_instance.EndTime</code></Paragraph>
                    <Paragraph>Duration: <code>@_instance.DurationInMillis</code></Paragraph>
                    <Paragraph>Started By User ID: <code>@_instance.StartUserId</code></Paragraph>
                    <Paragraph>Start Activity Id: <code>@_instance.StartActivityId</code></Paragraph>
                </CardBody>
            </Card>
        </Column>
        <Column>
            <Card>
                <CardHeader>BPMN Diagram</CardHeader>
                <CardBody Style="height: 700px">
                    <BpmnViewer bpmnXml="@bpmnXml"
                                activityIncidentCounts="@_activityIncidentCounts"
                                activeActivityCounts="@_activeActivityCounts"
                                completedActivityInstanceCounts="@_completedActivityInstanceCounts"
                                waitingExecutionCounts="@_waitingExecutionCounts"
                                applyCompletedActivityMarker="true"
                                completedActivityMarkerConfig="highlight">
                        <activityIncidentCountDisplay>
                            <Badge Color="Color.Danger">@context</Badge>
                        </activityIncidentCountDisplay>
                        <activeActivityCountDisplay>
                            <Badge Color="Color.Primary">@context</Badge>
                        </activeActivityCountDisplay>
                        <completedActivityInstanceCountDisplay>
                            <Badge Color="Color.Success">@context</Badge>
                        </completedActivityInstanceCountDisplay>
                        <waitingExecutionCountDisplay>
                            <Badge Color="Color.Secondary">@context</Badge>
                        </waitingExecutionCountDisplay>
                    </BpmnViewer>
                </CardBody>
            </Card>
        </Column>
        @*<Column ColumnSize="ColumnSize.Is3.OnDesktop">
                    <Card Style="height:100%">
                        <CardHeader>Selected Element Properties</CardHeader>
                        <CardBody Style="max-height: 700px">
                            ...todo: when selecting a element in the bpmn, the element's properties/configuration will appear here.  plus add reset/re-center diagram button.
                        </CardBody>
                    </Card>
                </Column>*@
    </Row>
    <Row Margin="Margin.Is1.OnY">
        <Column>
            <Card>
                <CardHeader>
                    <CardTitle>Process Instance Details</CardTitle>
                </CardHeader>
                <CardBody>
                    <Tabs SelectedTab="@_selectedTabName" SelectedTabChanged="@OnSelectedTabChanged" Justified=true Pills=true>
                        <Items>
                            <Tab Name="variables">Variables</Tab>
                            <Tab Name="incidents">Incidents</Tab>
                            <Tab Name="calledProcessInstances">Called Process Instances</Tab>
                            <Tab Name="userTasks">User Tasks</Tab>
                            <Tab Name="jobs">Jobs</Tab>
                            <Tab Name="externalTasks">External Tasks</Tab>
                            <Tab Name="actions">Actions</Tab>
                        </Items>
                        <Content>
                            <TabPanel Name="variables">
                                <Card Margin="Margin.Is2.OnY">
                                    <CardBody>
                                        @if (_selectedTabName == "variables")
                                        {
                                            <Card Margin="Margin.Is1.OnY">
                                                <CardHeader>
                                                    <CardTitle>Runtime</CardTitle>
                                                </CardHeader>
                                                <CardBody>
                                                    <RuntimeVariableInstanceDataGrid Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                                </CardBody>
                                            </Card>
                                            <Card Margin="Margin.Is1.OnY">
                                                <CardHeader>
                                                    <CardTitle>Historic</CardTitle>
                                                </CardHeader>
                                                <CardBody>
                                                    <HistoricVariableInstanceDataGrid Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                                </CardBody>
                                            </Card>
                                        }
                                    </CardBody>
                                </Card>
                            </TabPanel>
                            <TabPanel Name="incidents">
                                <Card Margin="Margin.Is2.OnY">
                                    <CardBody>
                                        @if (_selectedTabName == "incidents")
                                        {
                                            <Card Margin="Margin.Is1.OnY">
                                                <CardHeader>
                                                    <CardTitle>Runtime</CardTitle>
                                                </CardHeader>
                                                <CardBody>
                                                    <RuntimeIncidentDataGrid Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                                </CardBody>
                                            </Card>
                                            <Card Margin="Margin.Is1.OnY">
                                                <CardHeader>
                                                    <CardTitle>Historic</CardTitle>
                                                </CardHeader>
                                                <CardBody>
                                                    <HistoricIncidentDataGrid Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                                </CardBody>
                                            </Card>
                                        }
                                    </CardBody>
                                </Card>
                            </TabPanel>
                            <TabPanel Name="calledProcessInstances">
                                @if (_selectedTabName == "calledProcessInstances")
                                {
                                    <Card Margin="Margin.Is1.OnY">
                                        <CardHeader>
                                            <CardTitle>Runtime</CardTitle>
                                        </CardHeader>
                                        <CardBody>
                                            <CalledRuntimeProcessInstancesDataGrid Camunda="@_camunda" SuperProcessInstanceId="@InstanceId"/>
                                        </CardBody>
                                    </Card>
                                    <Card Margin="Margin.Is1.OnY">
                                        <CardHeader>
                                            <CardTitle>Historic</CardTitle>
                                        </CardHeader>
                                        <CardBody>
                                            <CalledHistoricProcessInstancesDataGrid Camunda="@_camunda" SuperProcessInstanceId="@InstanceId"/>
                                        </CardBody>
                                    </Card>
                                }
                            </TabPanel>
                            <TabPanel Name="userTasks">
                                @if (_selectedTabName == "userTasks")
                                {
                                    <Card Margin="Margin.Is1.OnY">
                                        <CardHeader>
                                            <CardTitle>Runtime</CardTitle>
                                        </CardHeader>
                                        <CardBody>
                                            <RuntimeUserTaskDataGrid Camunda="@_camunda" ProcessInstanceId="@InstanceId"></RuntimeUserTaskDataGrid>
                                        </CardBody>
                                    </Card>
                                    <Card Margin="Margin.Is1.OnY">
                                        <CardHeader>
                                            <CardTitle>Historic</CardTitle>
                                        </CardHeader>
                                        <CardBody>
                                            <HistoricUserTaskDataGrid Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                        </CardBody>
                                    </Card>
                                }
                            </TabPanel>
                            <TabPanel Name="jobs">
                                @if (_selectedTabName == "jobs")
                                {
                                    <Card Margin="Margin.Is1.OnY">
                                        <CardHeader>
                                            <CardTitle>Runtime</CardTitle>
                                        </CardHeader>
                                        <CardBody>
                                            <RuntimeJobDataGrid Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                        </CardBody>
                                    </Card>
                                    <Card Margin="Margin.Is1.OnY">
                                        <CardHeader>
                                            <CardTitle>Historic Job Log</CardTitle>
                                        </CardHeader>
                                        <CardBody>
                                            <HistoricJobDataGrid Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                        </CardBody>
                                    </Card>
                                }
                            </TabPanel>
                            <TabPanel Name="externalTasks">
                                @if (_selectedTabName == "externalTasks")
                                {
                                    <Card Margin="Margin.Is1.OnY">
                                        <CardHeader>
                                            <CardTitle>Runtime</CardTitle>
                                        </CardHeader>
                                        <CardBody>
                                            <RuntimeExternalTaskDataGrid Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                        </CardBody>
                                    </Card>
                                    <Card Margin="Margin.Is1.OnY">
                                        <CardHeader>
                                            <CardTitle>Historic External Task Log</CardTitle>
                                        </CardHeader>
                                        <CardBody>
                                            <HistoricExternalTaskDataGrid Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                        </CardBody>
                                    </Card>
                                }
                            </TabPanel>
                            <TabPanel Name="actions">
                                Suspend, Add Variables, Increment Retries, Delete Instance, Migrate
                            </TabPanel>

                        </Content>
                    </Tabs>
                </CardBody>
            </Card>
        </Column>
    </Row>
}
else
{
    <Row>
        <Card>
            <CardBody>
                No process instance found: @InstanceId
            </CardBody>
        </Card>
    </Row>
}
</Container>


@code {

    [Parameter]
    public string DefinitionId { get; set; }

    [Parameter]
    public string InstanceId { get; set; }

    CamundaClient _camunda;

    HistoricProcessInstanceDto _instance;

    private Dictionary<string, int> _activityIncidentCounts = new();

    private Dictionary<string, int> _activeActivityCounts = new();

    private Dictionary<string, int> _completedActivityInstanceCounts = new();
    
    private Dictionary<string, int> _waitingExecutionCounts = new();

    private string _selectedTabName;

    private ElementReference canvasReference;

    private string bpmnXml;

    private ActivityInstanceDto _activityInstanceData;

    private void OnSelectedTabChanged(string name)
    {
        _selectedTabName = name;
    }

    protected override async Task OnInitializedAsync()
    {
        _camunda = AppData.CamundaClient;

        _instance = await _camunda.Api.HistoricProcessInstanceApi.GetHistoricProcessInstanceAsync(id: InstanceId);

        _activityInstanceData = await GetActivityInstanceData(); //runtime data

        _activityIncidentCounts = _activityInstanceData.ChildActivityInstances
            .SelectMany(i => i.Incidents)
            .GroupBy(i => i.ActivityId)
            .Select(i => new {activityId = i.Key, count = i.Count()})
            .ToDictionary(x => x.activityId, x => x.count);

    //@TODO review how Transition Instance incidents are calculated

        _activeActivityCounts = _activityInstanceData.ChildActivityInstances
            .GroupBy(i=>i.ActivityId)
            .ToDictionary(k => k.Key, v => v.Select(i=>i.ExecutionIds).Count());

        _waitingExecutionCounts = _activityInstanceData.ChildTransitionInstances
            .GroupBy(i=>i.ActivityId)
            .ToDictionary(k => k.Key, v => v.Count());

        @*completedActivityInstanceCounts = (await camunda.History.ActivityInstances
            .Query(new HistoricActivityInstanceQuery() { ProcessInstanceId = instanceId, Finished = true }).List())
            .GroupBy(i => i.ActivityId)
            .Select(i => new { activityId = i.Key, count = i.Count() })
            .ToDictionary(x => x.activityId, x => x.count);*@

        bpmnXml = await GetBpmnXml(_instance.ProcessDefinitionId);

        StateHasChanged();
    }

    private Task<ActivityInstanceDto> GetActivityInstanceData()
    {
        return _camunda.Api.ProcessInstanceApi.GetActivityInstanceTreeAsync(InstanceId);
    }

        @*private Task<Dictionary<string, int>> CalcIncidents(ActivityInstanceInfo data)
        {
            return Task.FromResult(new Dictionary<string, int>());
        }*@

        @*private Task<Dictionary<string, int>> CalcActiveActivities(ActivityInstanceInfo data)
        {
            return Task.FromResult(new Dictionary<string, int>());
        }*@

        @*private Task<Dictionary<string, int>> CalcWaitingJobs(ActivityInstanceInfo data)
        {
            return Task.FromResult(new Dictionary<string, int>());
        }*@


    private async Task<string> GetBpmnXml(string processDefinitionId)
    {
        var result = await _camunda.Api.ProcessDefinitionApi.GetProcessDefinitionBpmn20XmlAsync(processDefinitionId);
        return result.Bpmn20Xml;
    }

}