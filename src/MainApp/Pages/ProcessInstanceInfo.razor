@using MainApp.Components.VariableInstance
@using MainApp.Components.Incident
@using MainApp.Components.UserTask
@using MainApp.Components.ProcessInstance
@using MainApp.Components.Job
@using MainApp.Components.ExternalTask
@using BpmnJs.Components
@using Camunda.Http.Api
@using Camunda.Http.Api.Model
@using Color = MudBlazor.Color

@inject AppData AppData

@page "/process-instances/{instanceId}"

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-16">
<MudGrid>
<MudItem xs="12">
    <MudText Typo="Typo.h3" GutterBottom="true">Process Instance <code>@InstanceId</code> Details</MudText>
</MudItem>
@if (_instance != null)
{
    <MudItem xs="12" lg="4">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>Process Instance Attributes</CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body1" GutterBottom="true">Process Instance ID: <code>@_instance.Id</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">State: <code>@_instance.State</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">Process Definition ID: <code>@_instance.ProcessDefinitionId</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">Process Definition Key: <code>@_instance.ProcessDefinitionKey</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">Process Definition Name: <code>@_instance.ProcessDefinitionName</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">Super Process Instance Id: <code>@_instance.SuperProcessInstanceId</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">Tenant ID: <code>@_instance.TenantId</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">Business Key: <code>@_instance.BusinessKey</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">Started At: <code>@_instance.StartTime</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">Ended At: <code>@_instance.EndTime</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">Duration: <code>@_instance.DurationInMillis</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">Started By User ID: <code>@_instance.StartUserId</code></MudText>
                <MudText Typo="Typo.body1" GutterBottom="true">Start Activity Id: <code>@_instance.StartActivityId</code></MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" lg="8">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>BPMN Diagram</CardHeaderContent>
            </MudCardHeader>
            <MudCardContent Style="height: 500px">
                @* Review why this is needed:*@
                @if (_bpmnXml != null)
                {
                    <BpmnViewer bpmnXml="@_bpmnXml"
                                activityIncidentCounts="@_activityIncidentCounts"
                                activeActivityCounts="@_activeActivityCounts"
                                completedActivityInstanceCounts="@_completedActivityInstanceCounts"
                                waitingExecutionCounts="@_waitingExecutionCounts"
                                applyCompletedActivityMarker="true"
                                completedActivityMarkerConfig="highlight">
                        <activityIncidentCountDisplay>
                            <MudBadge Color="Color.Error" Content="@context"/>
                        </activityIncidentCountDisplay>
                        <activeActivityCountDisplay>
                            <MudBadge Color="Color.Primary" Content="@context"/>
                        </activeActivityCountDisplay>
                        <completedActivityInstanceCountDisplay>
                            <MudBadge Color="Color.Success" Content="@context"/>
                        </completedActivityInstanceCountDisplay>
                        <waitingExecutionCountDisplay>
                            <MudBadge Color="Color.Secondary" Content="@context"/>
                        </waitingExecutionCountDisplay>
                    </BpmnViewer>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>Process Instance Details</CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudTabs>

                    <MudTabPanel Text="Variables" @ref="_variablesPanel">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Runtime</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <RuntimeVariableInstancesTable Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Historic</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <HistoricVariableInstancesTable Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>

                    <MudTabPanel Text="Incidents" @ref="_incidentsPanel">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Runtime</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <RuntimeIncidentsTable Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Historic</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <HistoricIncidentsTable Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        </MudGrid>


                    </MudTabPanel>

                    <MudTabPanel Text="Called Process Instances" @ref="_calledProcessInstancesPanel">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Runtime</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <RuntimeCalledProcessInstancesTable Camunda="@_camunda" SuperProcessInstanceId="@InstanceId"/>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Historic</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <HistoricCalledProcessInstancesTable Camunda="@_camunda" SuperProcessInstanceId="@InstanceId"/>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        </MudGrid>


                    </MudTabPanel>

                    <MudTabPanel Text="User Tasks" @ref="_userTasksPanel">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Runtime</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <RuntimeUserTasksTable Camunda="@_camunda" ProcessInstanceId="@InstanceId"></RuntimeUserTasksTable>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Historic</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <HistoricUserTasksTable Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>

                    <MudTabPanel Text="Jobs" @ref="_jobsPanel">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Runtime</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <RuntimeJobsTable Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Historic Job Log</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <HistoricJobsTable Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        </MudGrid>

                    </MudTabPanel>

                    <MudTabPanel Text="External Tasks" @ref="_externalTasksPanel">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Runtime</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <RuntimeExternalTasksTable Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12">
                                <MudCard>
                                    <MudCardHeader>
                                        <CardHeaderContent>Historic External Task Log</CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <HistoricExternalTasksTable Camunda="@_camunda" ProcessInstanceId="@InstanceId"/>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>

                    <MudTabPanel Text="Actions" @ref="_actionsPanel">
                        Suspend, Add Variables, Increment Retries, Delete Instance, Migrate
                    </MudTabPanel>

                </MudTabs>
            </MudCardContent>
        </MudCard>
    </MudItem>
}


</MudGrid>
</MudContainer>


@code {

    [Parameter]
    public string DefinitionId { get; set; }

    [Parameter]
    public string InstanceId { get; set; }

    CamundaClient _camunda;

    HistoricProcessInstanceDto _instance;

    private Dictionary<string, int> _activityIncidentCounts = new();

    private Dictionary<string, int> _activeActivityCounts = new();

    private Dictionary<string, int> _completedActivityInstanceCounts = new();

    private Dictionary<string, int> _waitingExecutionCounts = new();

    private string _bpmnXml;

    private ActivityInstanceDto _activityInstanceData;

    MudTabPanel _variablesPanel;
    MudTabPanel _incidentsPanel;
    MudTabPanel _calledProcessInstancesPanel;
    MudTabPanel _userTasksPanel;
    MudTabPanel _jobsPanel;
    MudTabPanel _externalTasksPanel;
    MudTabPanel _actionsPanel;


    protected override async Task OnInitializedAsync()
    {
        _camunda = AppData.CamundaClient;

        _instance = await _camunda.Api.HistoricProcessInstanceApi.GetHistoricProcessInstanceAsync(id: InstanceId);

        _activityInstanceData = await GetActivityInstanceData(); //runtime data

        _activityIncidentCounts = _activityInstanceData.ChildActivityInstances
            .SelectMany(i => i.Incidents)
            .GroupBy(i => i.ActivityId)
            .Select(i => new {activityId = i.Key, count = i.Count()})
            .ToDictionary(x => x.activityId, x => x.count);

    //@TODO review how Transition Instance incidents are calculated

        _activeActivityCounts = _activityInstanceData.ChildActivityInstances
            .GroupBy(i => i.ActivityId)
            .ToDictionary(k => k.Key, v => v.Select(i => i.ExecutionIds).Count());

        _waitingExecutionCounts = _activityInstanceData.ChildTransitionInstances
            .GroupBy(i => i.ActivityId)
            .ToDictionary(k => k.Key, v => v.Count());

        @*completedActivityInstanceCounts = (await camunda.History.ActivityInstances
            .Query(new HistoricActivityInstanceQuery() { ProcessInstanceId = instanceId, Finished = true }).List())
            .GroupBy(i => i.ActivityId)
            .Select(i => new { activityId = i.Key, count = i.Count() })
            .ToDictionary(x => x.activityId, x => x.count);*@

        _bpmnXml = await GetBpmnXml(_instance.ProcessDefinitionId);

        StateHasChanged();
    }

    private Task<ActivityInstanceDto> GetActivityInstanceData()
    {
        return _camunda.Api.ProcessInstanceApi.GetActivityInstanceTreeAsync(InstanceId);
    }

        @*private Task<Dictionary<string, int>> CalcIncidents(ActivityInstanceInfo data)
        {
            return Task.FromResult(new Dictionary<string, int>());
        }*@

        @*private Task<Dictionary<string, int>> CalcActiveActivities(ActivityInstanceInfo data)
        {
            return Task.FromResult(new Dictionary<string, int>());
        }*@

        @*private Task<Dictionary<string, int>> CalcWaitingJobs(ActivityInstanceInfo data)
        {
            return Task.FromResult(new Dictionary<string, int>());
        }*@


    private async Task<string> GetBpmnXml(string processDefinitionId)
    {
        var result = await _camunda.Api.ProcessDefinitionApi.GetProcessDefinitionBpmn20XmlAsync(processDefinitionId);
        return result.Bpmn20Xml;
    }

}